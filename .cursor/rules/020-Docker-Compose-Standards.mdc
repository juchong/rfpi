---
description: >
  Standards for authoring and validating Docker Compose files used by services.
globs:
  - "**/docker-compose*.yml"
  - "**/compose*.yaml"
alwaysApply: false
---

# Compose Standards

- Target **Compose v2 schema**; prefer `docker compose` over legacy `docker-compose`.
- Required sanity checks before any deploy:
  - `docker compose -f <file> config` MUST pass with no warnings/errors.
  - Ensure `restart: unless-stopped` (or justified alternative) for long-running services.
  - Add `healthcheck` where service provides a clear check endpoint.
- Networking
  - Use **named networks** for inter-service isolation; avoid `network_mode: host` unless justified.
  - Do not bind all ports with `0.0.0.0:*` unless required; prefer reverse proxy exposure.
- Storage
  - Use **named volumes** for persistent data; never remove without explicit approval.
  - Document mount paths and backup expectations in comments.
- Logging
  - Standardize to `json-file` or `local` driver with rotation (e.g., `max-size: "10m", max-file: "5"`).

## WUD (What's Up Docker) Auto-Updates

WUD (`/mnt/gooey/docker/stacks/docker-mgmt`) monitors and auto-updates containers. See `docker-mgmt/WUD.md` for full documentation.

### Key Configuration Patterns

**Environment variable format:**
```
WUD_{component}_{type}_{name}_{config_item}=value
```

**Registry providers** (for ghcr.io/lscr.io):
```yaml
- WUD_REGISTRY_GHCR_PUBLIC_USERNAME=${GITHUB_USERNAME}
- WUD_REGISTRY_GHCR_PUBLIC_TOKEN=${GITHUB_TOKEN}
- WUD_REGISTRY_LSCR_PUBLIC_USERNAME=${GITHUB_USERNAME}
- WUD_REGISTRY_LSCR_PUBLIC_TOKEN=${GITHUB_TOKEN}
```

**Auto-update triggers** (per stack):
```yaml
- WUD_TRIGGER_DOCKERCOMPOSE_{STACKNAME}_FILE=/wud/stacks/{stack}.yaml
- WUD_TRIGGER_DOCKERCOMPOSE_{STACKNAME}_PRUNE=true
```

### Adding a New Stack to WUD

1. Add volume mount in WUD compose.yaml:
   ```yaml
   - /mnt/gooey/docker/stacks/{stack}/compose.yaml:/wud/stacks/{stack}.yaml:ro
   ```

2. Add trigger environment variables:
   ```yaml
   - WUD_TRIGGER_DOCKERCOMPOSE_{STACKNAME}_FILE=/wud/stacks/{stack}.yaml
   - WUD_TRIGGER_DOCKERCOMPOSE_{STACKNAME}_PRUNE=true
   ```

3. Restart WUD: `cd /mnt/gooey/docker/stacks/docker-mgmt && sudo docker compose up -d`

4. Verify trigger registered: `sudo docker logs wud 2>&1 | grep "{stackname}"`

### Important Notes

- Trigger names must be alphanumeric (no hyphens): `plex-a` â†’ `PLEXA`
- Compose files must be mounted read-only (`:ro`) into WUD container
- ghcr/lscr registries require GitHub PAT with `read:packages` scope
- Custom/local images cannot be auto-updated (not in any registry)
